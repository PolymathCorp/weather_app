name: Ensure CODEOWNERS on Dispatch

on:
  repository_dispatch:
    types: [ensure-codeowners]

permissions:
  contents: write

jobs:
  ensure:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.PAT_TOKEN }}  # Use PAT with 'repo' and 'read:org' scopes

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Check for existing CODEOWNERS
        id: exists
        uses: andstor/file-existence-action@v2
        with:
          files: |
            CODEOWNERS
            .github/CODEOWNERS

      - name: Generate CODEOWNERS if missing
        if: steps.exists.outputs.files_exists == 'false'
        run: |
          echo "Generating CODEOWNERS for $GITHUB_REPOSITORY"
          echo "# Autogenerated CODEOWNERS" > CODEOWNERS

          # Fetch collaborators with push or admin permissions
          collaborators=$(gh api repos/${GITHUB_REPOSITORY}/collaborators \
            --jq '[.[] | select(.permissions.push == true or .permissions.admin == true) | "@"+.login]' | jq -r '. | join(" ")')

          if [ -z "$collaborators" ]; then
            echo "⚠️ No collaborators found, defaulting to repo owner"
            echo "* @${GITHUB_REPOSITORY_OWNER}" >> CODEOWNERS
          else
            echo "* $collaborators" >> CODEOWNERS
          fi

          echo "Generated CODEOWNERS:"
          cat CODEOWNERS

      - name: Commit and push CODEOWNERS
        if: steps.exists.outputs.files_exists == 'false'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          file_pattern: CODEOWNERS
          commit_message: "chore: add CODEOWNERS from collaborators"
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
